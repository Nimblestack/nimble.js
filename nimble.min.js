var Nimble=Nimble||{};(function(){"use strict";var _self;Nimble=function(){_self=this;_self.created=true};Nimble.prototype={BAD_API_URL:"API Unavailable. Please verify the URL in app-config.js. Possibly your baseUrl is not set to https://datadipity.com?",_tmp_email:"",_tmp_password:"",created:false,BaseUrl:null,appnml:null,appconfig:[],setAppConfig:function(_config){_self.appconfig=_config;window.localStorage.appconfig=JSON.stringify(_config)},handleLogin:null,initWithData:true,loginIndex:0,loadDialogCallback:null,homePageId:null,isGap:false,onGetData:null,search:"0",setHomePageId:function(id){_self.homePageId=id},getHomePageId:function(){return _self.homePageId},setBaseUrl:function(dev,url,protocol,host){_self.BaseUrl=protocol+"://"+host+"/"+dev+"/"+url},getBaseUrl:function(){return _self.BaseUrl},setSession:function(sess,index){try{var a=JSON.parse(window.localStorage.appconfig);a[index].sessid=sess;window.localStorage.appconfig=JSON.stringify(a)}catch(err){throw err}},getSession:function(index){var a=JSON.parse(window.localStorage.appconfig);return a[index].sessid},add:function(action,pagesType,callback,index){var next=null;if(callback!==null){next=callback}else{next=_self.processPageData}_self.setBaseUrl(config.developer,_self.appconfig[index].url,config.protocol,config.host);$.ajax({type:"GET",url:_self.BaseUrl+"/"+pagesType+".json?_method=post&_action="+action+"&PHPSESSID="+_self.getSession(index),crossDomain:true,dataType:"text",success:function(data){next(data)},error:_self.failedRequest})},update:function(action,pageType,pageId,callback,index){var next=null;if(callback!==null){next=callback}else{next=_self.processPageData}_self.setBaseUrl(config.developer,_self.appconfig[index].url,config.protocol,config.host);$.ajax({type:"GET",url:_self.BaseUrl+"/"+pageType+"/"+pageId+".json?_method=put&_action="+action+"&PHPSESSID="+_self.getSession(index),crossDomain:true,dataType:"text",success:function(data){next(data)},error:_self.failedRequest})},remove:function(pageType,pageId,callback,index){var next=null;if(callback!==null){next=callback}else{next=_self.processPageData}_self.setBaseUrl(config.developer,_self.appconfig[index].url,config.protocol,config.host);$.ajax({type:"GET",url:_self.BaseUrl+"/"+pageType+"/"+pageId+".json?_method=delete&PHPSESSID="+_self.getSession(index),crossDomain:true,dataType:"text",success:function(data){next(data)},error:_self.failedRequest})},get:function(index,callback,withUpdate,postparams,pageType,pageId,pageUrl){var next=null;if(callback){next=callback}else{next=null}_self.setBaseUrl(config.developer,_self.appconfig[index].url,config.protocol,config.host);var reqUrl=_self.BaseUrl;try{if(pageType!==null&&pageType!==undefined&&(pageId===null||pageId===undefined)){reqUrl=_self.BaseUrl+"/"+pageType.toLowerCase()}else if(pageId!==null&&pageId!==undefined&&(pageType===null||pageType===undefined)){throw new Error({name:"Configuration Error",level:"Cancel Request",message:"pageType cannot be null when pageId is not. this.get()"})}else if(pageId!==null&&pageId!==undefined&&(pageType!==null&&pageType!==undefined)){reqUrl=_self.BaseUrl+"/"+pageType.toLowerCase()+"/"+pageId.toLowerCase()}}catch(err){throw err}if(pageUrl!==null&&pageUrl!==undefined){reqUrl=_self.BaseUrl+"/"+pageUrl.toLowerCase()}var sessid=_self.getSession(index);var withSession=false;if(sessid!="null"&&sessid!="undefined"&&sessid!==null&&sessid!==undefined){withSession=true}if(withSession){if(withUpdate===true){reqUrl+=".json?update&PHPSESSID="+sessid}else{reqUrl+=".json?PHPSESSID="+sessid}}else{if(withUpdate===true){reqUrl+=".json?update"}else{reqUrl+=".json"}}if(postparams!==undefined&&postparams!==null&&postparams.length>0){var c=postparams.length;for(var i=0;i<c;i++){if(i===0&&!withUpdate&&!withSession){reqUrl+="?postparam["+postparams[i].name+"]="+postparams[i].value}else{reqUrl+="&postparam["+postparams[i].name+"]="+postparams[i].value}}}console.log("Getting: "+reqUrl);$.ajax({type:"GET",url:reqUrl,crossDomain:true,dataType:"text",success:function(data){next(data)},error:_self.failedRequest})},getWithFile:function(Filedata,callback,index,postparams,native){var next=null;if(callback!==null){next=callback}else{next=_self.processPageData}_self.setBaseUrl(config.developer,_self.appconfig[index].url,config.protocol,config.host);var postUrl=_self.BaseUrl+".json?update&PHPSESSID="+this.getSession(index);if(postparams!==undefined&&postparams!==null&&postparams.length>0){var c=postparams.length;for(var i=0;i<c;i++){postUrl+="&postparam["+postparams[i].name+"]="+postparams[i].value}}if(!native){$.ajax({type:"POST",url:postUrl,crossDomain:true,processData:false,contentType:false,data:Filedata,dataType:"text",success:function(data){next(data)},error:_self.failedRequest})}else{var ft=new FileTransfer;var options=new FileUploadOptions;options.fileKey="Filedata";options.fileName="image.jpg";options.mimeType="image/jpeg";ft.upload(Filedata.localURL,encodeURI(postUrl),function(data){next(data.response)},_self.failedRequest,options,true)}},failedRequest:function(xhr,status,err){console.log(err);console.log(status);console.log(JSON.stringify(xhr));throw err},processPageData:function(data){_self.search=data.ListPage.search;_self.setHomePageId(data.ListPage["@attributes"].id)},Register:function(userName,userEmail,userPassword1,userPassword2,callback){var next=null;if(callback!==null){next=callback}else{next=_self.onRegister}if(userEmail.length===0){alert("Enter valid email address");return false}var re=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if(!re.test(userEmail)){alert("Enter valid email address");return false}if(userName.length===0){alert("Enter name");return false}if(userPassword1.length===0){alert("Enter password");return false}if(userPassword2.length===0){alert("Repeat password");return false}if(userPassword1!==userPassword2){alert("Password is not the same");return false}_self.setBaseUrl(config.developer,_self.appconfig[_self.loginIndex].url,config.protocol,config.host);$.ajax({type:"POST",url:_self.BaseUrl+"/register/doRegister.json",crossDomain:true,data:{name:userName,email:userEmail,password:userPassword1},success:function(data){next(data)},error:function(err){console.log("Registration Failed!");console.log(JSON.stringify(err))}})},onRegister:function(data){if(data.success===true||data.success=="true"){console.log(_self.loginIndex);_self.setSession(data.session.id,_self.loginIndex);if(data.registerApis===true||data.registerApis=="true"){window.open(_self.BaseUrl+"/register/apis?PHPSESSID="+_self.getSession(_self.loginIndex),"App Authorization","directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=400,height=350")}}},Logout:function(sessid,callback){var next=null;if(callback!==null){next=callback}else{next=_self.onLogin}_self.setBaseUrl(config.developer,_self.appconfig[_self.loginIndex].url,config.protocol,config.host);$.ajax({type:"GET",url:_self.BaseUrl+"/login/logout.json?PHPSESSID="+sessid,crossDomain:true,success:function(data){next(data)},error:function(res,status,err){console.log("Logout Failed! - "+status);throw err}})},Login:function(userEmail,userPassword,callback){var next=null;if(callback!==null){next=callback}else{next=_self.onLogin}_self.setBaseUrl(config.developer,_self.appconfig[_self.loginIndex].url,config.protocol,config.host);console.log(_self.BaseUrl+"/login/doLogin.json");$.ajax({type:"GET",url:_self.BaseUrl+"/login/doLogin.json",crossDomain:true,data:{email:userEmail,password:userPassword},success:function(data,status,xhr){next(data)},error:function(res,status,err){console.log("Login Failed! - "+status);console.log(res);console.log(err);throw err}})},onLogin:function(data){if(data.success===true||data.success==="true"){_self.setSession(data.session.id,_self.loginIndex)}},manageAuthRedirect:function(callback){$("#loader").modal("hide");$("#generic").modal("show");$("#authlink").attr("href",_self.BaseUrl+"/register/apis?PHPSESSID="+_self.getSession(_self.loginIndex));console.log(_self.BaseUrl+"/register/apis?PHPSESSID="+_self.getSession(_self.loginIndex));$("#authlink").bind("click",function(evt){$("#authlink").unbind("click");evt.preventDefault();var url=evt.currentTarget.href;var popup=window.open(url,"_blank","location=yes");if(!_self.isGap){var timer=setInterval(function(evt){if(popup.closed){clearInterval(timer);$("#generic").modal("hide");callback()}},500)}else{popup.addEventListener("exit",function(){$("#generic").modal("hide");callback()})}})}}})();function generateUUID(){var d=(new Date).getTime();var uuid="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=(d+Math.random()*16)%16|0;d=Math.floor(d/16);return(c=="x"?r:r&3|8).toString(16)});return uuid}var hash=generateUUID();var app=app||{};(function(){"use strict";var _self;app=function(){_self=this;this.created=true};app.prototype={isGap:false,nimble:null,fb:null,socket:null,json:{},started:false,savePassword:false,initialize:function(){_self.bindEvents()},bindEvents:function(){if(document.location.protocol==="file:"){_self.isGap=true;document.addEventListener("deviceready",_self.onDeviceReady,false)}else{$(document).ready(_self.onDeviceReady)}},onDeviceReady:function(){$("#lr_load").hide();_self.nimble=new Nimble;_self.nimble.initWithData=config.initWithData;_self.nimble.isGap=_self.isGap;_self.nimble.onGetData=_self.onGetData;if(config.hasOwnProperty("fbUrl")){_self.fb=new Firebase(config.fbUrl)}$("#registerToggle").bind("click",function(evt){console.log("Register Toggle Clicked");if(_self.isGap){cordova.InAppBrowser.open(config.protocol+"://"+config.host+"/"+config.developer+"/group/"+config.group+"/show","_system")}else{window.open(config.protocol+"://"+config.host+"/"+config.developer+"/group/"+config.group+"/show","_blank")}});_self.nimble.setBaseUrl(config.appconfig[0].url,config.protocol,config.host);_self.nimble.loginHandler=app.onLoginOrRegister;if(!config.autoLogin){_self.nimble.setAppConfig(config.appconfig);_self.runLogin()}},runLogin:function(){if(config.autoLogin){if(_self.isGap){_self.nimble.Login(device.uuid+"@clickslide.co","password",_self.onLoginOrRegister)}else{if(window.localStorage.hash){_self.nimble.Login(window.localStorage.hash+"@clickslide.co","password",_self.onLoginOrRegister)}else{_self.nimble.Login(hash+"@clickslide.co","password",_self.onLoginOrRegister)}}}else{if(_self.nimble.loginIndex===0&&!window.localStorage._tmp_email&&!window.localStorage._tmp_password){$("#loginRegister").modal("show");$("#modalTitle").text("Login");$("#loginForm").on("submit",_self.handleLogin)}else{if(_self.fb&&!window.localStorage.firebaseUser){_self.registerFirebaseUser()}if(window.localStorage._savePassword){$("#loader").modal("show")}_self.nimble.Login(window.localStorage._tmp_email,window.localStorage._tmp_password,_self.onLoginOrRegister)}}},handleLogin:function(evt){evt.preventDefault();$("#lr_load").show();var email=$("#loginEmail").val();var password=$("#loginPassword").val();_self.savePassword=$("#savePassword").is(":checked");window.localStorage._savePassword=_self.savePassword;if(_self.nimble.loginIndex===0){window.localStorage._tmp_email=email;window.localStorage._tmp_password=password;window.localStorage._tmp_name=email.split("@")[0];window.localStorage._tmp_password2=password}_self.nimble.Login(email,password,_self.onLoginOrRegister)},handleRegister:function(evt){evt.preventDefault();var email=$("#registerEmail").val();var name=email.split("@")[0];var password=$("#registerPassword").val();var password2=$("#registerPassword2").val();if(_self.nimble.loginIndex===0){window.localStorage._tmp_email=email;window.localStorage._tmp_password=password;window.localStorage._tmp_name=name;window.localStorage._tmp_password2=password2}$("#lr_load").show();_self.nimble.Register(name,email,password,password2,_self.onLoginOrRegister)},initGui:function(){},onGetData:function(data){},registerFirebaseUser:function(){console.log("creating fb user");_self.fb.createUser({email:window.localStorage._tmp_email,password:window.localStorage._tmp_password},function(error,userData){if(error){switch(error.code){case"EMAIL_TAKEN":console.log("The new user account cannot be created because the email is already in use.");break;case"INVALID_EMAIL":console.log("The specified email is not a valid email.");break;default:console.log("Error creating user:",error)}}else{console.log("Successfully created user account with uid:",userData.uid);window.localStorage.firebaseUser=userData.uid}})},onLoginOrRegister:function(data){console.log(data);if(data instanceof Object){if(data.session!==null&&data.session!==undefined){if(data.registerApis===true||data.registerApis==="true"){if(!config.autoLogin){$("#lr_load").hide()}if(!window.localStorage._savePassword){delete window.localStorage._savePassword;delete window.localStorage._tmp_password;delete window.localStorage._tmp_name;delete window.localStorage._tmp_password2}$("#failedLogin").html("You must authorize all services. Please click login via the website to continue. <a href='"+config.protocol+"://"+config.host+"/"+config.developer+"/group/"+config.group+"/show' target='_blank'>Login Here</a>")}else{_self.nimble.onLogin(data);if(_self.nimble.loginIndex<_self.nimble.appconfig.length-1){_self.nimble.loginIndex++;_self.runLogin()}else{if(_self.fb){_self.fb.authWithPassword({email:window.localStorage._tmp_email,password:window.localStorage._tmp_password},function(error,authData){if(error){console.log("Login Failed!",error)}else{console.log("Authenticated successfully with payload:",authData);window.localStorage.firebaseToken=authData.token;window.localStorage.firebaseUser=authData.uid}})}if(!config.autoLogin){$("#lr_load").hide();$("#loginRegister").modal("hide")}if(!window.localStorage._savePassword){delete window.localStorage._savePassword;delete window.localStorage._tmp_email;delete window.localStorage._tmp_password;delete window.localStorage._tmp_password2}if(_self.nimble.initWithData){$("#loader").modal("show");_self.nimble.get(config.startIndex,_self.nimble.onGetData,true)}else{if(!_self.started){_self.initGui()}else{$("#loader").modal("hide")}}}}}else{if(config.autoLogin){if(_self.isGap){_self.nimble.Register(device.uuid,device.uuid+"@clickslide.co","password","password",_self.onLoginOrRegister)}else{window.localStorage.hash=hash;_self.nimble.Register(hash,hash+"@clickslide.co","password","password",_self.onLoginOrRegister)}}else{if(_self.nimble.loginIndex===0){$("#lr_load").hide();$("#modalTitle").text("Register");$("#registerToggle").tab("show");$("#failedLogin").html(data.message)}else{$("#loader").modal("show");_self.nimble.Register(window.localStorage._tmp_name,window.localStorage._tmp_email,window.localStorage._tmp_password,window.localStorage._tmp_password2,_self.onLoginOrRegister)}}}}else{throw new Error(_self.nimble.BAD_API_URL)}}}})();